<!DOCTYPE html>
<html lang="en">
  <head>
    <meta
      http-equiv="Content-Security-Policy"
      content="
        default-src 'self' 'unsafe-inline' blob: resource: https://unpkg.com/@pdf-lib/fontkit/dist/fontkit.umd.js;
        object-src 'self' blob:;
        frame-src 'self' blob:;
      "
    />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link rel="stylesheet" type="text/css" href="/apps/web/index.css" />
    <title>Test 17</title>
    <script type="text/javascript" src="/dist/pdf-lib.js"></script>
    <script type="text/javascript" src="/apps/web/utils.js"></script>
    <script
      type="text/javascript"
      src="https://unpkg.com/@pdf-lib/fontkit/dist/fontkit.umd.js"
    ></script>
  </head>

  <body>
    <div id="button-container">
      <button onclick="window.location.href = '/apps/web/test16.html'">
        Prev
      </button>
      <button onclick="test()">Run Test</button>
      <button disabled onclick="window.location.href = '/apps/web/test18.html'">
        Next
      </button>
    </div>
    <div id="animation-target"></div>
    <iframe id="iframe"></iframe>
  </body>

  <script type="text/javascript">
    startFpsTracker('animation-target');

    const fetchBinaryAsset = (asset) =>
      fetch(`/assets/${asset}`).then((res) => res.arrayBuffer());

    const renderInIframe = (pdfBytes) => {
      const blob = new Blob([pdfBytes], { type: 'application/pdf' });
      const blobUrl = URL.createObjectURL(blob);
      document.getElementById('iframe').src = blobUrl;
    };

    async function test() {
      const { PDFDocument } = PDFLib;

      const [fancyFieldsPdf, ubuntuR] = await Promise.all([
        fetchBinaryAsset('pdfs/fancy_fields.pdf'),
        fetchBinaryAsset('fonts/ubuntu/Ubuntu-R.ttf'),
      ]);

      const pdfDoc = await PDFDocument.load(fancyFieldsPdf);

      pdfDoc.registerFontkit(fontkit);
      const ubuntuFont = await pdfDoc.embedFont(ubuntuR);

      const form = pdfDoc.getForm();

      // Text Fields
      const prefix = form.getTextField('Prefix ⚽️');
      prefix.updateAppearances(ubuntuFont);

      const firstName = form.getTextField('First Name 🚀');
      firstName.updateAppearances(ubuntuFont);

      const middleInitial = form.getTextField('MiddleInitial 🎳');
      middleInitial.updateAppearances(ubuntuFont);

      const lastName = form.getTextField('LastName 🛩');
      lastName.updateAppearances(ubuntuFont);

      // Check Boxes
      const isAFairy = form.getCheckBox('Are You A Fairy? 🌿');
      isAFairy.updateAppearances();

      const isPowerLevelOver9000 = form.getCheckBox(
        'Is Your Power Level Over 9000? 💪',
      );
      isPowerLevelOver9000.updateAppearances();

      const onePunch = form.getCheckBox(
        'Can You Defeat Enemies In One Punch? 👊',
      );
      onePunch.updateAppearances();

      const everLetMeDown = form.getCheckBox('Will You Ever Let Me Down? ☕️');
      everLetMeDown.updateAppearances();

      // Buttons
      const eject = form.getButton('Eject 📼');
      eject.updateAppearances(ubuntuFont);

      const submit = form.getButton('Submit 📝');
      submit.updateAppearances(ubuntuFont);

      const play = form.getButton('Play ▶️');
      play.updateAppearances(ubuntuFont);

      const launch = form.getButton('Launch 🚀');
      launch.updateAppearances(ubuntuFont);

      // Radio Group
      const historicalFigures = form.getRadioGroup('Historical Figures 🐺');
      historicalFigures.updateAppearances();

      // Option List
      const planets = form.getOptionList('Which Are Planets? 🌎');
      planets.updateAppearances(ubuntuFont);

      // Dropdown
      const gundams = form.getDropdown('Choose A Gundam 🤖');
      gundams.updateAppearances(ubuntuFont);

      const pdfBytes = await pdfDoc.save();

      renderInIframe(pdfBytes);
    }
  </script>
</html>
